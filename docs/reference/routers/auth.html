<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>shopapi.routers.auth API documentation</title>
<meta name="description" content="Login-related API endpoints" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>shopapi.routers.auth</code></h1>
</header>
<section id="section-intro">
<p>Login-related API endpoints</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Login-related API endpoints
&#34;&#34;&#34;

import logging

from typing import Optional, Union
from urllib.parse import urljoin
from fastapi import APIRouter, Cookie, Depends

from fastapi_sso.sso.base import SSOBase
from fastapi_sso.sso.google import GoogleSSO
from fastapi_sso.sso.facebook import FacebookSSO
from fastapi_sso.sso.microsoft import MicrosoftSSO
from starlette.requests import Request
from starlette.responses import JSONResponse, RedirectResponse, Response

from shopapi import schemas
from shopapi.config import Config
from shopapi.helpers import exceptions, dependencies
from shopapi import actions

logger = logging.getLogger(__name__)

router = APIRouter(prefix=&#34;/auth&#34;, tags=[&#34;authentication&#34;])


def _provider_factory(provider: str) -&gt; SSOBase:
    provider_view = router.url_path_for(&#34;auth_sso_callback&#34;, provider=provider)
    redirect_uri = urljoin(Config.base_url.rstrip(&#34;/&#34;) + &#34;/&#34;, provider_view.lstrip(&#34;/&#34;))
    if provider == &#34;facebook&#34;:
        if Config.SSO.facebook_enabled and Config.SSO.facebook_client_secret and Config.SSO.facebook_client_id:
            return FacebookSSO(
                client_id=Config.SSO.facebook_client_id,
                client_secret=Config.SSO.facebook_client_secret,
                redirect_uri=redirect_uri,
            )
    elif provider == &#34;google&#34;:
        if Config.SSO.google_enabled and Config.SSO.google_client_secret and Config.SSO.google_client_id:
            return GoogleSSO(
                client_id=Config.SSO.google_client_id,
                client_secret=Config.SSO.google_client_secret,
                redirect_uri=redirect_uri,
            )
    elif provider == &#34;microsoft&#34;:
        if Config.SSO.microsoft_enabled and Config.SSO.microsoft_client_secret and Config.SSO.microsoft_client_id:
            return MicrosoftSSO(
                client_id=Config.SSO.microsoft_client_id,
                client_secret=Config.SSO.microsoft_client_secret,
                redirect_uri=redirect_uri,
            )
    raise NotImplementedError(f&#34;Provider &#39;{provider}&#39; is not implemented or not allowed&#34;)


@router.post(&#34;/login&#34;)
async def auth_login(user: schemas.api.LoginUserIn):
    &#34;&#34;&#34;Login using username / password&#34;&#34;&#34;
    return user


@router.get(&#34;/sso/{provider}/login&#34;)
async def auth_sso_login(provider: str):
    &#34;&#34;&#34;Return redirect to sso provider&#39;s login&#34;&#34;&#34;
    sso = _provider_factory(provider)
    return await sso.get_login_redirect()


@router.get(&#34;/sso/{provider}/callback&#34;)
async def auth_sso_callback(
    provider: str,
    request: Request,
    redirect_to: Optional[str] = Cookie(None),
    ssoaction: str = Cookie(&#34;login&#34;),
    token: Optional[str] = Depends(dependencies.get_user_token),
):
    &#34;&#34;&#34;Process sso provider&#39;s login callback and login user&#34;&#34;&#34;
    sso = _provider_factory(provider)
    openidsso = await sso.verify_and_process(request)
    if openidsso is None:
        raise exceptions.AuthenticationException()
    openid = schemas.schemas.OpenID.from_sso(openidsso)
    if ssoaction == &#34;add-provider&#34;:
        if not token:
            raise exceptions.AuthenticationException()
        logged_user = await dependencies.get_user(token)
        await actions.user.user_add_openid(openid, logged_user.id)
        response = JSONResponse(
            {
                &#34;detail&#34;: f&#34;User {logged_user.id} - {logged_user.email} was added &#34;
                f&#34;openid {openid.provider}/{openid.provider_id}&#34;
            }
        )
        response.delete_cookie(&#34;ssoaction&#34;)
        return response
    else:
        user = await actions.user.get_or_create_user(openid)
        return await actions.user.login_user(user, permanent=True, redirect_to=redirect_to, openid=openid)


@router.get(&#34;/sso/{provider}/add&#34;)
async def auth_sso_add(provider: str, user: schemas.schemas.UserToken = Depends(dependencies.get_user)):
    &#34;&#34;&#34;Begin flow for adding another provider to existing user&#34;&#34;&#34;
    logger.info(&#34;Requesting to add provider %s for user %d - %s&#34;, provider, user.id, user.email)
    sso = _provider_factory(provider)
    response = await sso.get_login_redirect()
    response.set_cookie(&#34;ssoaction&#34;, &#34;add-provider&#34;)
    return response</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="shopapi.routers.auth.auth_login"><code class="name flex">
<span>async def <span class="ident">auth_login</span></span>(<span>user: <a title="shopapi.schemas.api.LoginUserIn" href="../schemas/api.html#shopapi.schemas.api.LoginUserIn">LoginUserIn</a>)</span>
</code></dt>
<dd>
<div class="desc"><p>Login using username / password</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.post(&#34;/login&#34;)
async def auth_login(user: schemas.api.LoginUserIn):
    &#34;&#34;&#34;Login using username / password&#34;&#34;&#34;
    return user</code></pre>
</details>
</dd>
<dt id="shopapi.routers.auth.auth_sso_add"><code class="name flex">
<span>async def <span class="ident">auth_sso_add</span></span>(<span>provider: str, user: <a title="shopapi.schemas.schemas.UserToken" href="../schemas/schemas.html#shopapi.schemas.schemas.UserToken">UserToken</a> = Depends(get_user))</span>
</code></dt>
<dd>
<div class="desc"><p>Begin flow for adding another provider to existing user</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.get(&#34;/sso/{provider}/add&#34;)
async def auth_sso_add(provider: str, user: schemas.schemas.UserToken = Depends(dependencies.get_user)):
    &#34;&#34;&#34;Begin flow for adding another provider to existing user&#34;&#34;&#34;
    logger.info(&#34;Requesting to add provider %s for user %d - %s&#34;, provider, user.id, user.email)
    sso = _provider_factory(provider)
    response = await sso.get_login_redirect()
    response.set_cookie(&#34;ssoaction&#34;, &#34;add-provider&#34;)
    return response</code></pre>
</details>
</dd>
<dt id="shopapi.routers.auth.auth_sso_callback"><code class="name flex">
<span>async def <span class="ident">auth_sso_callback</span></span>(<span>provider: str, request: starlette.requests.Request, redirect_to: Optional[str] = Cookie(None), ssoaction: str = Cookie(login), token: Optional[str] = Depends(get_user_token))</span>
</code></dt>
<dd>
<div class="desc"><p>Process sso provider's login callback and login user</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.get(&#34;/sso/{provider}/callback&#34;)
async def auth_sso_callback(
    provider: str,
    request: Request,
    redirect_to: Optional[str] = Cookie(None),
    ssoaction: str = Cookie(&#34;login&#34;),
    token: Optional[str] = Depends(dependencies.get_user_token),
):
    &#34;&#34;&#34;Process sso provider&#39;s login callback and login user&#34;&#34;&#34;
    sso = _provider_factory(provider)
    openidsso = await sso.verify_and_process(request)
    if openidsso is None:
        raise exceptions.AuthenticationException()
    openid = schemas.schemas.OpenID.from_sso(openidsso)
    if ssoaction == &#34;add-provider&#34;:
        if not token:
            raise exceptions.AuthenticationException()
        logged_user = await dependencies.get_user(token)
        await actions.user.user_add_openid(openid, logged_user.id)
        response = JSONResponse(
            {
                &#34;detail&#34;: f&#34;User {logged_user.id} - {logged_user.email} was added &#34;
                f&#34;openid {openid.provider}/{openid.provider_id}&#34;
            }
        )
        response.delete_cookie(&#34;ssoaction&#34;)
        return response
    else:
        user = await actions.user.get_or_create_user(openid)
        return await actions.user.login_user(user, permanent=True, redirect_to=redirect_to, openid=openid)</code></pre>
</details>
</dd>
<dt id="shopapi.routers.auth.auth_sso_login"><code class="name flex">
<span>async def <span class="ident">auth_sso_login</span></span>(<span>provider: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Return redirect to sso provider's login</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.get(&#34;/sso/{provider}/login&#34;)
async def auth_sso_login(provider: str):
    &#34;&#34;&#34;Return redirect to sso provider&#39;s login&#34;&#34;&#34;
    sso = _provider_factory(provider)
    return await sso.get_login_redirect()</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="shopapi.routers" href="index.html">shopapi.routers</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="shopapi.routers.auth.auth_login" href="#shopapi.routers.auth.auth_login">auth_login</a></code></li>
<li><code><a title="shopapi.routers.auth.auth_sso_add" href="#shopapi.routers.auth.auth_sso_add">auth_sso_add</a></code></li>
<li><code><a title="shopapi.routers.auth.auth_sso_callback" href="#shopapi.routers.auth.auth_sso_callback">auth_sso_callback</a></code></li>
<li><code><a title="shopapi.routers.auth.auth_sso_login" href="#shopapi.routers.auth.auth_sso_login">auth_sso_login</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>