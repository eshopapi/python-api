<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>shopapi.helpers.security API documentation</title>
<meta name="description" content="Security helpers" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>shopapi.helpers.security</code></h1>
</header>
<section id="section-intro">
<p>Security helpers</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Security helpers
&#34;&#34;&#34;

import logging
from datetime import datetime, timedelta
from typing import Mapping, Optional

from jose import jwt
from jose.exceptions import JWTError
from passlib.context import CryptContext

from shopapi.schemas import schemas, models
from shopapi import constants
from shopapi.helpers import exceptions
from shopapi.config import Config

logger = logging.getLogger(__name__)

pwd_context = CryptContext(schemes=[&#34;bcrypt&#34;], deprecated=&#34;auto&#34;)


def verify_password(pwd_test: str, pwd_hash: str) -&gt; bool:
    &#34;&#34;&#34;Verify input password string with password hash from database

    Returns:
        bool -- True or False whether verified
    &#34;&#34;&#34;
    return pwd_context.verify(pwd_test, pwd_hash)


def get_password_hash(password: str) -&gt; bytes:
    &#34;&#34;&#34;Get password string hashed to be saved in db&#34;&#34;&#34;
    return pwd_context.hash(password).encode(&#34;ascii&#34;)


def create_access_token(
    user: schemas.UserFromDB, expires: Optional[timedelta] = None, openid: Optional[schemas.OpenID] = None
) -&gt; str:
    &#34;&#34;&#34;Create jwt token based on user information.
    Only `id` and `email` fields are actually used to build jwt.
    Optional `expires` specifies when the token expires, otherwise, default is used from config.
    &#34;&#34;&#34;
    expires = expires or timedelta(minutes=Config.access_token_expire)
    data = {
        &#34;iss&#34;: Config.base_url,
        &#34;nbf&#34;: datetime.utcnow(),
        &#34;iat&#34;: datetime.utcnow(),
        &#34;sub&#34;: user.email,
        &#34;sid&#34;: user.id,
        &#34;exp&#34;: datetime.utcnow() + expires,
        &#34;pvd&#34;: openid.provider if openid else &#34;password&#34;,
        &#34;pid&#34;: openid.provider_id if openid else None,
        &#34;rid&#34;: user.role_id,
    }
    jwt_content = jwt.encode(data, Config.secret_key, algorithm=constants.JWT_ALGORITHM)
    return jwt_content


async def decode_jwt(token: str) -&gt; Mapping:
    &#34;&#34;&#34;Get token info from token&#34;&#34;&#34;
    try:
        payload = jwt.decode(token, Config.secret_key, algorithms=[constants.JWT_ALGORITHM])
        expires = datetime.fromtimestamp(float(payload.get(&#34;exp&#34;, 0)))
        if datetime.utcnow() &gt;= expires:
            raise exceptions.CredentialsExpired()
        return payload
    except JWTError as error:
        logger.error(error)
        raise exceptions.CredentialsException()  # pylint: disable=raise-missing-from


async def user_from_jwt(token: str) -&gt; schemas.UserFromDB:
    &#34;&#34;&#34;Get user object from jwt token

    Arguments:
        token {str} -- JWT token

    Raises:
        exceptions.CredentialsException: If the token is missing,
            invalid or the user specified within does not exist

    Returns:
        models.User -- User from DB
    &#34;&#34;&#34;
    payload = await decode_jwt(token)
    user_id = payload.get(&#34;sub&#34;)
    if user_id is None:
        raise exceptions.CredentialsException()
    user = await models.User.get(user_id)
    if user is None:
        raise exceptions.CredentialsException()
    return schemas.UserFromDB.from_orm(user)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="shopapi.helpers.security.create_access_token"><code class="name flex">
<span>def <span class="ident">create_access_token</span></span>(<span>user: <a title="shopapi.schemas.schemas.UserFromDB" href="../schemas/schemas.html#shopapi.schemas.schemas.UserFromDB">UserFromDB</a>, expires: Optional[datetime.timedelta] = None, openid: Optional[<a title="shopapi.schemas.schemas.OpenID" href="../schemas/schemas.html#shopapi.schemas.schemas.OpenID">OpenID</a>] = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Create jwt token based on user information.
Only <code>id</code> and <code>email</code> fields are actually used to build jwt.
Optional <code>expires</code> specifies when the token expires, otherwise, default is used from config.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_access_token(
    user: schemas.UserFromDB, expires: Optional[timedelta] = None, openid: Optional[schemas.OpenID] = None
) -&gt; str:
    &#34;&#34;&#34;Create jwt token based on user information.
    Only `id` and `email` fields are actually used to build jwt.
    Optional `expires` specifies when the token expires, otherwise, default is used from config.
    &#34;&#34;&#34;
    expires = expires or timedelta(minutes=Config.access_token_expire)
    data = {
        &#34;iss&#34;: Config.base_url,
        &#34;nbf&#34;: datetime.utcnow(),
        &#34;iat&#34;: datetime.utcnow(),
        &#34;sub&#34;: user.email,
        &#34;sid&#34;: user.id,
        &#34;exp&#34;: datetime.utcnow() + expires,
        &#34;pvd&#34;: openid.provider if openid else &#34;password&#34;,
        &#34;pid&#34;: openid.provider_id if openid else None,
        &#34;rid&#34;: user.role_id,
    }
    jwt_content = jwt.encode(data, Config.secret_key, algorithm=constants.JWT_ALGORITHM)
    return jwt_content</code></pre>
</details>
</dd>
<dt id="shopapi.helpers.security.decode_jwt"><code class="name flex">
<span>async def <span class="ident">decode_jwt</span></span>(<span>token: str) ‑> Mapping</span>
</code></dt>
<dd>
<div class="desc"><p>Get token info from token</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def decode_jwt(token: str) -&gt; Mapping:
    &#34;&#34;&#34;Get token info from token&#34;&#34;&#34;
    try:
        payload = jwt.decode(token, Config.secret_key, algorithms=[constants.JWT_ALGORITHM])
        expires = datetime.fromtimestamp(float(payload.get(&#34;exp&#34;, 0)))
        if datetime.utcnow() &gt;= expires:
            raise exceptions.CredentialsExpired()
        return payload
    except JWTError as error:
        logger.error(error)
        raise exceptions.CredentialsException()  # pylint: disable=raise-missing-from</code></pre>
</details>
</dd>
<dt id="shopapi.helpers.security.get_password_hash"><code class="name flex">
<span>def <span class="ident">get_password_hash</span></span>(<span>password: str) ‑> bytes</span>
</code></dt>
<dd>
<div class="desc"><p>Get password string hashed to be saved in db</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_password_hash(password: str) -&gt; bytes:
    &#34;&#34;&#34;Get password string hashed to be saved in db&#34;&#34;&#34;
    return pwd_context.hash(password).encode(&#34;ascii&#34;)</code></pre>
</details>
</dd>
<dt id="shopapi.helpers.security.user_from_jwt"><code class="name flex">
<span>async def <span class="ident">user_from_jwt</span></span>(<span>token: str) ‑> <a title="shopapi.schemas.schemas.UserFromDB" href="../schemas/schemas.html#shopapi.schemas.schemas.UserFromDB">UserFromDB</a></span>
</code></dt>
<dd>
<div class="desc"><p>Get user object from jwt token</p>
<h2 id="arguments">Arguments</h2>
<p>token {str} &ndash; JWT token</p>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>exceptions.CredentialsException</code></dt>
<dd>If the token is missing,
invalid or the user specified within does not exist</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>models.User &ndash; User from DB</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def user_from_jwt(token: str) -&gt; schemas.UserFromDB:
    &#34;&#34;&#34;Get user object from jwt token

    Arguments:
        token {str} -- JWT token

    Raises:
        exceptions.CredentialsException: If the token is missing,
            invalid or the user specified within does not exist

    Returns:
        models.User -- User from DB
    &#34;&#34;&#34;
    payload = await decode_jwt(token)
    user_id = payload.get(&#34;sub&#34;)
    if user_id is None:
        raise exceptions.CredentialsException()
    user = await models.User.get(user_id)
    if user is None:
        raise exceptions.CredentialsException()
    return schemas.UserFromDB.from_orm(user)</code></pre>
</details>
</dd>
<dt id="shopapi.helpers.security.verify_password"><code class="name flex">
<span>def <span class="ident">verify_password</span></span>(<span>pwd_test: str, pwd_hash: str) ‑> bool</span>
</code></dt>
<dd>
<div class="desc"><p>Verify input password string with password hash from database</p>
<h2 id="returns">Returns</h2>
<p>bool &ndash; True or False whether verified</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def verify_password(pwd_test: str, pwd_hash: str) -&gt; bool:
    &#34;&#34;&#34;Verify input password string with password hash from database

    Returns:
        bool -- True or False whether verified
    &#34;&#34;&#34;
    return pwd_context.verify(pwd_test, pwd_hash)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="shopapi.helpers" href="index.html">shopapi.helpers</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="shopapi.helpers.security.create_access_token" href="#shopapi.helpers.security.create_access_token">create_access_token</a></code></li>
<li><code><a title="shopapi.helpers.security.decode_jwt" href="#shopapi.helpers.security.decode_jwt">decode_jwt</a></code></li>
<li><code><a title="shopapi.helpers.security.get_password_hash" href="#shopapi.helpers.security.get_password_hash">get_password_hash</a></code></li>
<li><code><a title="shopapi.helpers.security.user_from_jwt" href="#shopapi.helpers.security.user_from_jwt">user_from_jwt</a></code></li>
<li><code><a title="shopapi.helpers.security.verify_password" href="#shopapi.helpers.security.verify_password">verify_password</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>